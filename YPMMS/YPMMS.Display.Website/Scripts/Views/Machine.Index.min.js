"use strict";$.ajaxSetup({cache:!1});var MachineIndex=new function(){function b(){$(document).on("click touchstart","#incomePerformanceMonthsGraphContainer .graph-body .bars-outer:not(.disabled)",function(){r=$(this).attr("data-month");f(!1,!1)})}function l(){$("#monthsLeftArrowButton").bind("click",d);$("#monthsRightArrowButton").bind("click",k)}function a(){$("#daysLeftArrowButton").bind("click",nt);$("#daysRightArrowButton").bind("click",g)}function k(){u<moment().year()&&u++;e=!0;h();f()}function d(){u--;e=!0;h();f()}function g(){r<moment().month()+1&&r++;f()}function nt(){r>1&&r--;f()}function v(){o===0&&e&&Tools.showLoading();o++}function y(){o--;o===0&&e&&Tools.hideLoading()}function h(){v();$.get("/Report/ReportShared/IncomePerformanceMonthsGraph",{year:u,machineId:n},function(n){$("#incomePerformanceMonthsGraphContainer").html(n);reportsRoot.refreshAll();l();y()})}function f(t,i){(i==null||i==undefined)&&(i=!0);v();$.get("/Report/ReportShared/IncomePerformanceDaysGraph",{year:u,month:r,machineId:n},function(n){$("#incomePerformanceDaysGraphContainer").html(n);$("#incomePerformanceDaysGraphContainer .graph-body.days").removeClass("hidden");t&&reportsRoot.selectIncomePerformanceDays();i&&reportsRoot.refreshAll();a();y()})}function tt(){$.get("/Machine/GetMachine/"+n,function(n){p(n)})}function c(t,i){var r=t?t.toISOString():null,u=i?i.toISOString():null;$.get("/Machine/CollectionsData",{machineId:n,from:r,to:u},function(n){it(n);ut(n)})}function p(t){var u,f,e;if(i.machineDetails.find(".system-name").text(t.Name).end().find(".site-name").text(t.Site.Name).end().find(".address").text(t.Site.FullAddress).end().find(".country").text(t.Site.Country).end().find(".assigned-collectors").text("TODO").end().find("#machine-status").toggleClass("warning",t.StatusIsFull).toggleClass("error",t.StatusIsError).text(t.StatusDescription).end(),t.Denominations&&t.Denominations.length)for($(".float-edit-input-container").remove(),t.Denominations.sort(function(n,t){return n.Value-t.Value}),u=0;u<t.Denominations.length;u++){var r=t.Denominations[u],o="denom-"+r.Id,h=s.floatLevelInput.clone().find("label").attr("for",o).text(Format.asCurrency(r.Value,r.Currency)).end().find(".float-level-update-field").attr("id",o).val(r.FloatLevel).end();h.appendTo(r.Type==="Coin"?i.coinFloatLevels:i.billFloatLevels)}if(t.SystemType=="BactaCash"&&$.get("/Machine/GetBacta/"+n,function(n){$(".bacta-manifest-row").remove();$.each(n,function(n,t){n!="Id"&&n!="Timestamp"&&n!="MachineId"&&s.bactaManifestRow.clone().find(".bacta-info-item").text(n).end().find(".bacta-info-value").text(t).end().appendTo(i.bactaTable)})}),t.Manifests&&t.Manifests.length)for($(".machine-manifest-row").remove(),f=0;f<t.Manifests.length;f++)e=t.Manifests[f],s.machineManifestRow.clone().find(".device-code").text(e.Device).end().find(".version").text(e.Version).end().find(".build-revision").html(e.BuildRevision||"&mdash;").end().appendTo(i.manifestTable);ft(t.Site.Latitude,t.Site.Longitude)}function it(n){var t;$(".collection-date-section").remove();var u=localStorage.getItem("CurrencyCode"),i=[],r='<table class="mobile-responsive individual-system-information table" id="tebsCollectionList">';for(t=0;t<n.length;t++)i.push([Format.asDateAndTime(n[t].Timestamp),'<a href="/Machine/TebsBag/'+n[t].TebsCode+'">'+n[t].TebsCode.replace(/^0+/,"")+"<\/a>",parseInt(n[t].KeyId).toString(),Format.asCurrency(n[t].amount,u,!0)]);r+="<\/table>";$("#collection-times").html(r);$.extend(jQuery.fn.dataTableExt.oSort);$("#tebsCollectionList").DataTable({order:[[0,"desc"]],data:i,columns:[{title:"Collected date"},{title:"Bag code"},{title:"Collector Id"},{title:"Amount collected"}],columnDefs:[{className:"dt-right",targets:3},{type:"date-uk",targets:0}]})}function rt(){var t={MachineId:n,Levels:[]};i.floatLevelsSection.find("input.float-level-update-field").each(function(){t.Levels.push({DenominationId:$(this).prop("id").replace("denom-",""),Level:$(this).val()})});$.post("/Machine/UpdateFloatLevels",t)}function ut(n){var r,s,f,h,e,u,p,b,c,l;i.chartHeadingStartDate.text(Format.asDate(DatePicker.startDate));i.chartHeadingEndDate.text(Format.asDate(DatePicker.endDate));r=new t.visualization.DataTable;r.addColumn("string","Date");r.addColumn("number","Collected Cash");r.addColumn("number","Refilled Cash");s="";f=[];for(h in n)n.hasOwnProperty(h)&&f.unshift(h);for(e=0;e<f.length;e++){var a=f[e],o=n[a],v=0,y=0;for(u=0;u<o.length;u++)v+=o[u].TotalCollected,y+=o[u].TotalRefilled;p=o.Country;b=Format.asCurrency(p);s=w||b;c=Format.asDate(a);r.addRow([{v:c,f:c},v,y])}l=new t.visualization.NumberFormat({prefix:s,negativeParens:!0});l.format(r,1);l.format(r,2)}function ft(n,i){var r=$(document).width()>1e3?!0:!1,u={center:new t.maps.LatLng(n,i),zoom:11,mapTypeId:t.maps.MapTypeId.ROADMAP,scrollwheel:!1,draggable:r,styles:MapDefaults.styles},f=new t.maps.Map(document.getElementById("map"),u),e=new t.maps.Marker({position:{lat:n,lng:i},map:f,title:212,icon:"/Content/img/map/pin.png"})}function et(){var t=$.connection.machineHub;t.client.updateMachineStatus=function(t){var i=t.Machine;i.Id===n&&p(i)};t.client.updateCollection=function(){c(DatePicker.startDate,DatePicker.endDate);e=!1;f();h()};t.client.updateMachine=function(t){var i,r,f,u;if(t.Machine.SystemType=="CashInTebs"||t.Machine.SystemType=="CashInBnv")$.get("/Machine/Bag/"+n,function(n){var r=t.Machine,i,e,f,u;if($("#"+r.Id+"-machine-details").length){for(i=r.Denominations[0].Currency,$(".last-update").find(".date").text(r.Date).end().find(".time").text(r.Time).end(),e=0;e<r.Denominations.length;e++)for(f=r.Denominations[e],u=0;u<n.count.length;u++)if(f.ValueInPence==n.count[u].Value*100){$(".cashbox-level-"+f.ValueInPence).text(n.count[u].Number);$(".collectable-level-"+f.ValueInPence).text(n.count[u].Number);$(".total-level-"+f.ValueInPence).text(n.count[u].Number);break}$(".cashbox-value-coins-total").text(Format.asCurrency(r.CoinsCashboxValue,i));$(".cashbox-value-bills-total").text(Format.asCurrency(n.total[0].Value,i));$(".cashbox-value-total").text(Format.asCurrency(n.total[0].Value,i));$(".stored-value-coins-total").text(Format.asCurrency(r.CoinsStoredValue,i));$(".stored-value-bills-total").text(Format.asCurrency(r.BillsStoredValue,i));$(".stored-value-total").text(Format.asCurrency(r.StoredValue,i));$(".total-value-coins-total").text(Format.asCurrency(r.CoinsTotalValue,i));$(".total-value-bills-total").text(Format.asCurrency(n.total[0].Value,i));$(".total-value-total").text(Format.asCurrency(n.total[0].Value,i));$(".float-value-coins-total").text(Format.asCurrency(r.CoinsFloatValue,i));$(".float-value-bills-total").text(Format.asCurrency(r.BillsFloatValue,i));$(".float-value-total").text(Format.asCurrency(r.FloatValue,i));$(".collectable-value-coins-total").text(Format.asCurrency(r.CoinsCollectableValue,i));$(".collectable-value-bills-total").text(Format.asCurrency(n.total[0].Value,i));$(".collectable-value-total").text(Format.asCurrency(n.total[0].Value,i))}});else if(i=t.Machine,$("#"+i.Id+"-machine-details").length){for(r=i.Denominations[0].Currency,$(".last-update").find(".date").text(i.Date).end().find(".time").text(i.Time).end(),f=0;f<i.Denominations.length;f++)u=i.Denominations[f],$(".stored-level-"+u.ValueInPence).text(u.StoredLevel),$(".cashbox-level-"+u.ValueInPence).text(u.CashboxLevel),$(".float-level-"+u.ValueInPence).text(u.FloatLevel),$(".collectable-level-"+u.ValueInPence).text(u.CollectableLevel),$(".total-level-"+u.ValueInPence).text(u.TotalLevel);$(".cashbox-value-coins-total").text(Format.asCurrency(i.CoinsCashboxValue,r));$(".cashbox-value-bills-total").text(Format.asCurrency(i.BillsCashboxValue,r));$(".cashbox-value-total").text(Format.asCurrency(i.CashboxValue,r));$(".stored-value-coins-total").text(Format.asCurrency(i.CoinsStoredValue,r));$(".stored-value-bills-total").text(Format.asCurrency(i.BillsStoredValue,r));$(".stored-value-total").text(Format.asCurrency(i.StoredValue,r));$(".total-value-coins-total").text(Format.asCurrency(i.CoinsTotalValue,r));$(".total-value-bills-total").text(Format.asCurrency(i.BillsTotalValue,r));$(".total-value-total").text(Format.asCurrency(i.TotalValue,r));$(".float-value-coins-total").text(Format.asCurrency(i.CoinsFloatValue,r));$(".float-value-bills-total").text(Format.asCurrency(i.BillsFloatValue,r));$(".float-value-total").text(Format.asCurrency(i.FloatValue,r));$(".collectable-value-coins-total").text(Format.asCurrency(i.CoinsCollectableValue,r));$(".collectable-value-bills-total").text(Format.asCurrency(i.BillsCollectableValue,r));$(".collectable-value-total").text(Format.asCurrency(i.CollectableValue,r))}};$.connection.hub.start().done()}var n=0,t=null,w=null,u=undefined,r=undefined,o=0,e=!1,i={collectionContainer:$("#collection-times"),floatLevelsSection:$(".float-level-update-fields"),updateFloatLevelsButton:$("#apply-float-levels-btn"),machineDetails:$(".individual-system-information"),manifestTable:$("#components-information-table"),bactaTable:$("#components-bacta-table"),coinFloatLevels:$(".coin-float-levels"),billFloatLevels:$(".bill-float-levels"),chartHeadingStartDate:$("#chart-heading-start-date"),chartHeadingEndDate:$("#chart-heading-end-date")},s={collectionRow:Tools.extractTemplate("#template__collection-row"),collectionDateSection:Tools.extractTemplate("#template__collection-date-section"),machineManifestRow:Tools.extractTemplate("#template__machine-manifest-row"),bactaManifestRow:Tools.extractTemplate("#template__bacta-manifest-row"),floatLevelInput:Tools.extractTemplate("#template__float-level")};this.initialise=function(f,e){n=f;t=e;DatePicker.setup("#reportrange","#reportrange span",function(n,t){c(n,t)});i.updateFloatLevelsButton.click(function(){rt()});t.charts.load("current",{packages:["corechart"]});t.charts.setOnLoadCallback(function(){tt();c(DatePicker.startDate,DatePicker.endDate)});et();u=moment().year();r=moment().month()+1;l();a();b()};$.extend(jQuery.fn.dataTableExt.oSort,{"date-uk-pre":function(n){return parseInt(moment(n,"DD/MM/YYYY").format("X"),10)},"date-uk-desc":function(n,t){return t-n},"date-uk-asc":function(n,t){return n-t}})};