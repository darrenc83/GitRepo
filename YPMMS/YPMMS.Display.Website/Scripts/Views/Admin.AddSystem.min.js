"use strict";$.ajaxSetup({cache:!1});var AdminAddSystem=new function(){function it(){$.get("/Seller/GetSellers",function(n){var t=n,i=$("<select>");$.each(t,function(n){i.append($("<option><\/option>").val(t[n].Id).html(t[n].SellersName))});$("#sellerDropDown").append(i.html())});$.get("/Terminal/GetTerminals",function(n){var t=n,i=$("<select>");$.each(t,function(n){i.append($("<option><\/option>").val(t[n].Id).html(t[n].Terminaltype))});$("#terminalDropDown").append(i.html())})}function rt(t){$.get("/Merchant/GetMerchant/"+t,function(t){var i=t;n.idField.addClass("disabled").parents(".input--haruki").addClass("input--filled").end().val(i.Id);n.merchantIdField.parents(".input--haruki").addClass("input--filled").end().val(i.MerchantId);n.merchantNameField.parents(".input--haruki").addClass("input--filled").end().removeAttr("disabled").val(i.MerchantName)})}function ut(n,t){$.get("/Admin/SitesData",function(i){s=i;ft(t);n&&n()})}function ft(t){var r,i;for($(".site-details").remove(),r=0;r<s.length;r++)i=s[r],tt.site.clone().attr("id","site-"+i.Id).find(".site-name").text(i.Name).end().find(".site-address").text(i.FullAddress).end().click(function(n){return function(){h(n,{zoomMap:!0})}}(i)).appendTo(n.sitesList);t&&h(machine.Site,{zoomMap:!0,scrollList:!0})}function r(n){n.siblings(".empty-message").fadeIn()}function l(n,t){var i=n.siblings(".error-message");t&&i.text(t);i.fadeIn()}function y(n){n.siblings(".success-icon").fadeIn()}function e(){$(".error-message, .empty-message, .success-icon").hide()}function et(){var t=!1,n,i;if(e(),n=document.getElementById("sellerDropDown"),i=n.options[n.selectedIndex].value,i==0&&(t=!0),t){$("#continue-to-terminal-selection").addClass("disabled");r($("#sellerDropDown"));return}$("#continue-to-terminal-selection").removeClass("disabled");e();w()}function ot(){function k(){b.Id=f;n.summaryMachineId.text(f);b.MerchantName=o;n.summaryMachineName.text(o);w()}var t=!1,i=!1,s=!1,h=!1,c=!1,f,o,a,v,p;if(e(),f=n.merchantIdField.val().trim(),t=f==="",t&&r(n.merchantIdField),o=n.merchantNameField.val().trim(),i=o==="",i&&r(n.merchantNameField),a=n.merchantApprovedDate.val().trim(),s=a==="",s&&r(n.merchantApprovedDate),v=n.merchantWelcomeCallDate.val().trim(),h=v==="",h&&r(n.merchantWelcomeCallDate),p=n.merchantApproxLiveDate.val().trim(),c=p==="",c&&r(n.merchantApproxLiveDate),t&&i){n.merchantPageNextButton.addClass("disabled");return}n.merchantPageNextButton.removeClass("disabled");$.get("/Admin/validateMerchantDetails",{merchantId:f,merchantName:o,editMode:u},function(r){!r.IdError||t||u||(t=!0,l(n.merchantIdField,r.IdErrorMessage));r.NameError&&!i&&(i=!0,l(n.merchantNameField,r.NameErrorMessage));t||u||y(n.merchantIdField);i||y(n.merchantNameField);t||i||setTimeout(function(){k()},400)})}function d(){var o,u,r,l,e,y;for(t=t||new i.Map(n.siteAddressMap[0],{zoom:10,center:{lat:0,lng:0},styles:MapDefaults.styles}),o=new i.LatLngBounds,p(),u=0;u<s.length;u++)r=s[u],l=new i.LatLng(r.Latitude,r.Longitude),o.extend(l),e=new i.Marker({position:l,title:r.Name,clickable:!0,icon:c.normal}),e.siteId=r.Id,e.addListener("click",function(n){return function(){h(n,{scrollList:!0})}}(r)),f.push(e);y={zoomOnClick:!0,imagePath:"/Content/img/map/m"};v=new MarkerClusterer(t,f,y);a=a||i.Marker.MAX_ZINDEX;t.fitBounds(o)}function p(){while(f.length>0){var n=f.pop();v&&v.removeMarker(n);n.setMap(null)}}function st(r,u){var e,s,h;if(u!=="OK"){g("Address could not be found. Please try again.");return}if(e=r[0],!nt(e)){g("Please enter a more specific address");return}n.siteAddressResultsContainer.fadeIn();n.siteSaveLocationButton.removeClass("disabled");p();s=e.geometry.location;h=new i.Marker({map:t,position:s,icon:c.normal,draggable:!0,title:"Drag to move"});f.push(h);t.setZoom(14);t.setCenter(e.geometry.location);h.addListener("dragend",function(t){ht(t.latLng,function(){s=t.latLng;n.siteAddressField.val(o.Postcode)},function(){h.setPosition(s)})})}function g(t){l(n.siteAddressField,t);n.siteAddressResultsContainer.hide();n.siteAddressResults.text("");n.siteSaveLocationButton.addClass("disabled")}function ht(n,t,r){(new i.Geocoder).geocode({location:n},function(n,i){i==="OK"&&nt(n[0])?t():r()})}function nt(t){var i={},f;for(i.Latitude=t.geometry.location.lat(),i.Longitude=t.geometry.location.lng(),f=0;f<t.address_components.length;f++){var e=t.address_components[f],r=e.long_name,u=e.types;u.indexOf("street_number")>-1&&(i.Address=r+" "+(i.Address||""));u.indexOf("route")>-1?i.Address=(i.Address||"")+r:u.indexOf("postal_town")>-1?i.Town=r:u.indexOf("postal_code")>-1?i.Postcode=r:u.indexOf("administrative_area_level_2")>-1?i.Area=r:u.indexOf("country")>-1&&(i.Country=r)}return i.Address&&i.Postcode&&i.Country?(o=i,n.siteAddressResults.text(t.formatted_address),!0):!1}function h(r,u){var s,o,e,h;if(machine.Site=r||null,n.selectedSiteNameHeading.text(r?r.Name:k.selectedSiteName),n.selectedSiteAddressCaption.text(r?r.FullAddress:k.selectedSiteAddress),r){for(s=n.sitesList.find("#site-"+r.Id),s.addClass("selected").siblings().removeClass("selected"),o=0;o<f.length;o++)e=f[o],e.siteId===r.Id?(e.setZIndex(++a),e.setIcon(c.selected)):e.setIcon(c.normal);u.zoomMap&&(t=t||new i.Map(n.siteAddressMap[0],{zoom:10,center:{lat:0,lng:0},styles:MapDefaults.styles}),t.setCenter({lat:r.Latitude,lng:r.Longitude}),t.setZoom(16));u.scrollList&&s[0].scrollIntoView({behavior:"smooth"})}else $(".site-details").removeClass("selected");h=machine.Site===null;n.sitePageNextButton.toggleClass("disabled",h)}function ct(){$.post("/Admin/AddMachine",machine,function(){window.location="/Admin/SystemManagement"}).fail(function(){})}function lt(){$.post("/Admin/EditMachine",machine,function(){window.location="/Admin/SystemManagement"}).fail(function(){})}function at(){$.post("/Admin/AddSite",o,function(t){ut(function(){n.siteSelectSiteAddressTab.click();d();h(t,{zoomMap:!0,scrollList:!0})})}).fail(function(){}).always(function(){o=null})}function vt(){$("section.content:not(.hidden)").addClass("hidden").prev().removeClass("hidden")}function w(){$("section.content:not(.hidden)").addClass("hidden").next().removeClass("hidden")}function yt(){$("section.content").addClass("hidden").first().removeClass("hidden")}var u=!1,b={},s=[],i=null,o=null,t=null,f=[],c={},a=0,v=null,n={idField:$("#id-field"),merchantIdField:$("#merchant-id-field"),merchantNameField:$("#merchant-name-field"),merchantApprovedDate:$("#approved-date"),merchantWelcomeCallDate:$("#welcome-call-date"),merchantApproxLiveDate:$("#approx-live-date"),merchantPageNextButton:$("#add-new-merchant-page .next-btn"),sellerPageNextButton:$("#add-new-seller-page .next-btn"),siteSelectSiteAddressTab:$("#select-site-address-tab"),summaryConfirmButton:$("#add-new-system-page-summary #confirm-details"),summaryEditDetailsButton:$("#add-new-system-page-summary #edit-details"),summaryMachineId:$("#summary-machine-id"),summaryMachineName:$("#summary-machine-name"),summarySiteName:$("#summary-site-name"),summarySiteAddress:$("#summary-site-address"),previousButtons:$(".previous-btn"),pages:$("section.content"),sitesList:$("#sites-list")},tt={site:Tools.extractTemplate("#template__site-details")},k={selectedSiteName:"",selectedSiteAddress:""};this.initialise=function(t,r){i=t.maps;u=r?!0:!1;u&&rt(r);it();$(".add-mode-heading").toggle(!u);$(".edit-mode-heading").toggle(u);n.previousButtons.click(function(){vt()});$("#continue-to-terminal-selection").click(function(){et()});n.merchantPageNextButton.click(function(){ot()});n.summaryEditDetailsButton.click(function(){yt()});n.summaryConfirmButton.click(function(){u?lt():ct()})}};